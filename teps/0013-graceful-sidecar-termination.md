---
title: sidecar-termination-control-flag
authors:
  - "@rifatshahnewaz"
creation-date: 2020-08-31
last-updated: 2020-08-31
status: in pr review
---

# TEP-0013: Enable graceful sidecar termination/Give termination control to the task author.

<!-- toc -->
- [Summary](#summary)
- [Motivation](#motivation)
  - [Goals](#goals)
  - [Non-Goals](#non-goals)
- [Proposal](#proposal)
  - [User Stories](#user-stories)
- [Design Details](#design-details)
- [Advantages](#advantages)
- [Test Plan](#test-plan)
- [Drawbacks](#drawbacks)
- [Alternatives](#alternatives)
- [References](#references)
<!-- /toc -->

## Summary

Currently, the sidecar feature in a tekton pipeline/taskrun is not behaving like a typical kubernetes sidecar should. 
The sidecar gets terminated immediately when the pipeline fails or completes without giving the sidecar enough time to 
do what it originally intended to do (for example, upload logs, process artifacts etc.)
In some cases the sidecar should be able to choose when to terminate itself. A sidecar is just a kubernetes container. 
It's able to terminate itself with the command completion.


This proposal is introducing a flag `waitForSidecar` which is a per-sidecar configuration that will allow users to set
the nature of termination of a sidecar inside a task.

## Motivation

The first motivation is the counter intuitive nature of the sidecars. As a developer, I did not expect my sidecar to be
terminated in such way. I had to check the docs to find out that the sidecar was being terminated using a Nop Image.

Having no way to alter the behavior was the second motivation.

Consider this task:
Task:
	- Step 1: Git Clone
	- Step 2: Helm Diff/Configure
	- Step 3: Helm Apply/Deploy
	- Step 4: E2E
		- Generates E2E artifacts
		- Exposes pod and container metadata using downwards API

	- Sidecar 1

		The author of the task adds `Sidecar 1` that does the following:
		- Polls the status of `Step 4` using downwards API.
		- When the `Step 4` container is terminated, regardless of the reason of termination (failed when e2e fails and completed when e2e passes), it process all the artifacts generated by `Step 4` (Generates HTML report, does trend building etc.) and uploads the resultant artifacts to a permanent storage (S3).

However, due to the current design, it terminates the sidecar immediately in case the E2E step fails. I.e., the `Step 4` container is terminated without success. 

### Goals

The goal of this proposal is to provide users more control over their sidecar container termination and make Tekton more flexible for complex implementation
scenarios without introducing any breaking changes.

The Nop Image termination can still be considered a good feature since in most cases, the sidecar does not need to run more than the pipelines lifetime and
a non optimized injected sidecar may hang the pipeline indefinitely.

### Non-Goals
This proposal is not introducing any breaking change to current behavior. Sidecars still terminate using Nop Image by default when the pipeline is completed/failed.

## Proposal

The proposal is that we’ll make it a “per-sidecar” configuration on whether Tekton should determine and force terminate the sidecars once task run is done. I.e.; all tekton steps in the task are completed. It will default to `false` so that the new mechanism will only take effect when explicitly set by the flag in Sidecar configuration.


### User Stories

A `Pipeline` author can add a Sidecar with `waitForSidecar` enabled (true) and expect `natural death` of his/her sidecar.

## Design Details

A `Task` can have multiple sidecar defined each behaving according to the flag. Injected sidecars are considered as `waitForsidecar` false since that's the
default behavior.

Example:

```yaml
apiVersion: tekton.dev/v1beta1
kind: Task
spec:
  sidecars:
  - env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: E2E_CONTAINER_NAME
      value: step-e2e
    - name: NAMESPACE
      value: test
    - name: BUILD_NUMBER
      value: "25"
    waitForSidecar: true
    image: rifatshahnewaz/e2e-uploader:prod
    name: publish-e2e-report
  - env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: LOG_STREAMER_CONTAINER_NAME
      value: step-log-streamer
    - name: NAMESPACE
      value: test
    - name: BUILD_NUMBER
      value: "25"
    waitForSidecar: false
    image: rifatshahnewaz/log-streamer:prod
    name: log-streamer

    volumeMounts:
    - mountPath: /coverage-results
      name: e2e-report
```

Golang Example:
```
s.TektonTask.Spec.Sidecars = []pipelinev1beta1.Sidecar{
	{
		Container: corev1.Container{
			Name:            "publish-e2e-report",
			Image:           "e2e-runner-image",
			Env: []corev1.EnvVar{
				{
					Name: "POD_NAME",
					ValueFrom: &corev1.EnvVarSource{
						FieldRef: &corev1.ObjectFieldSelector{
							FieldPath: "metadata.name",
						},
					},
				},
				{Name: "E2E_CONTAINER_NAME", Value: "step-e2e"},
				{Name: "NAMESPACE", Value: yaml.ProductName},
				{Name: "BUILD_NUMBER", Value: buildNumber},
			},
			VolumeMounts: []corev1.VolumeMount{{
				Name:      "e2e-volume",
				ReadOnly:  false,
				MountPath: "/coverage-results",
			}},
		},
		waitForSidecar: true,	
	},
		{
		Container: corev1.Container{
			Name:            "log-streamer",
			Image:           "log-streamer-image",
			Env: []corev1.EnvVar{
				{
					Name: "POD_NAME",
					ValueFrom: &corev1.EnvVarSource{
						FieldRef: &corev1.ObjectFieldSelector{
							FieldPath: "metadata.name",
						},
					},
				},
				{Name: "LOG_STREAMER_CONTAINER_NAME", Value: "log-streamer"},
				{Name: "NAMESPACE", Value: yaml.ProductName},
				{Name: "BUILD_NUMBER", Value: buildNumber},
			},
		},
	},
}

```

## Advantages

* No need to introduce another step for simpler tasks.

## Test Plan

* e2e and unit tests

## Drawbacks
Discussed in Cons.

**Pros/Cons:**
Pros:
Discussed above.
Cons:
Can't think of any. Unless the pipeline author adds a sidecar with this flag enabled and the sidecars' cmd is an infinite one. Causing the pipeline to hang
forever.

## Alternatives
Add WaitForSidecar flag to TaskRunSpec

```
apiVersion: tekton.dev/v1beta1
kind: TaskRun
spec:
  params:
  resources:
  serviceAccountName: git-sa-test-gitops-0800ac6-28
  taskRef:
    kind: Task
    name: task-test-gitops-0800ac6-c7298ca-28
  timeout: 2h0m0s
  waitForSidecar: true
```

Cons:
- Makes it difficult in case you want this behavior for only certain sidecars as the configuration will be applied universally for all sidecars in the task run.


## References

* https://github.com/tektoncd/pipeline/issues/1131
